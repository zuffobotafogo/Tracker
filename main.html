<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo de Aeroportos e Aviões</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        #map { height: 100vh; }
        #sidebar {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: white;
            overflow-y: auto;
            padding: 15px;
            z-index: 1000;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h4>✈️ Aviões em Tempo Real</h4>
        <input type="text" id="search" class="form-control" placeholder="Buscar aeroporto...">
        <ul id="aircraft-list" class="list-group mt-3"></ul>
    </div>

    <div id="map"></div>

    <script>
        let map = L.map('map').setView([0, 0], 3); // Centraliza o mapa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        let airportMarkers = {}; 
        let aircraftMarkers = {}; 

        let airplaneIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // Ícone de avião
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        // Carregar todos os aeroportos da AviationStack API
        async function loadAirports() {
            const API_KEY = "f3751f61a63e2e36d16c085ec0ea55d6";
            let response = await fetch(`http://api.aviationstack.com/v1/airports?access_key=${API_KEY}`);
            let data = await response.json();

            data.data.forEach(airport => {
                let marker = L.marker([airport.latitude, airport.longitude])
                    .addTo(map)
                    .bindPopup(`<b>${airport.airport_name} (${airport.iata_code})</b><br>${airport.city}, ${airport.country_name}`);
                
                airportMarkers[airport.iata_code] = marker;
            });
        }

        // Exibir aviões em tempo real da OpenSky Network API
        async function loadAircrafts() {
            let response = await fetch("https://opensky-network.org/api/states/all");
            let data = await response.json();

            document.getElementById('aircraft-list').innerHTML = ""; 

            let newAircraftMarkers = {};

            data.states.slice(0, 50).forEach(aircraft => {
                if (aircraft[6] !== null && aircraft[5] !== null) {
                    let icao24 = aircraft[0];

                    if (aircraftMarkers[icao24]) {
                        // Mover avião existente
                        aircraftMarkers[icao24].setLatLng([aircraft[6], aircraft[5]]);
                    } else {
                        // Criar novo avião
                        let marker = L.marker([aircraft[6], aircraft[5]], { icon: airplaneIcon })
                            .addTo(map)
                            .bindPopup(`<b>${aircraft[1]}</b><br>Altitude: ${aircraft[7]}m`);
                        
                        aircraftMarkers[icao24] = marker;
                    }
                    newAircraftMarkers[icao24] = aircraftMarkers[icao24];

                    let listItem = document.createElement("li");
                    listItem.className = "list-group-item";
                    listItem.innerText = `${aircraft[1]} - ${aircraft[2]}`;
                    document.getElementById("aircraft-list").appendChild(listItem);
                }
            });

            // Remover aviões que não estão mais na lista
            Object.keys(aircraftMarkers).forEach(icao => {
                if (!newAircraftMarkers[icao]) {
                    map.removeLayer(aircraftMarkers[icao]);
                    delete aircraftMarkers[icao];
                }
            });
        }

        // Atualiza aviões a cada 15 segundos
        setInterval(loadAircrafts, 15000);

        // Barra de pesquisa para buscar aeroportos
        document.getElementById("search").addEventListener("input", function () {
            let searchValue = this.value.toLowerCase();
            Object.values(airportMarkers).forEach(marker => {
                let popupContent = marker.getPopup().getContent().toLowerCase();
                if (popupContent.includes(searchValue)) {
                    marker.openPopup();
                }
            });
        });

        loadAirports();
        loadAircrafts();
    </script>

</body>
</html>